WITH hgrid AS (SELECT CDB_HexagonGrid(ST_Expand(!bbox!, greatest(!pixel_width!,!pixel_height!) * <%- multiplier %>), greatest(!pixel_width!,!pixel_height!) * <%- multiplier %>) as cell),
hexjoin AS (SELECT h.cell, d.id_partido, count(e.cartodb_id) as num_loc, array_to_string(array_agg(e.id_agrupado), ',') as loc_list, SUM(e.electores) as electores, SUM(e.votantes) as votantes,
SUM(e.positivos) as positivos, SUM(d.diferencia) as diferencia, SUM(d.votos_paso) as votos_paso, SUM(d.votos) as votos FROM arg_pv_localizaciones e, arg_pv_loc_diff_votos d, hgrid h
WHERE e.id_agrupado = d.id_agrupado
AND ST_Intersects(e.the_geom_webmercator, h.cell)
GROUP BY h.cell, id_partido
ORDER BY votos DESC),
hexsumm AS (SELECT g.*, row_number() over(partition by cell order by votos desc) as rk
FROM hexjoin g)
<%= subquery %>