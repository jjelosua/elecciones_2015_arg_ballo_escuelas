WITH hgrid AS (SELECT CDB_HexagonGrid(ST_Expand(!bbox!, greatest(!pixel_width!,!pixel_height!) * <%- multiplier %>), greatest(!pixel_width!,!pixel_height!) * <%- multiplier %>) as cell)
SELECT hgrid.cell as the_geom_webmercator, i.id_partido, array_to_string(array_agg(i.id_agrupado), ',') as agg_list, count(i.cartodb_id) as agg_cnt, (SUM(i.votos)/SUM(i.positivos)::float) as agg_perc, SUM(i.votos) as agg_votes, SUM(i.votos_paso) as agg_votes_prev, (SUM(i.votos) - SUM(i.votos_paso)) as agg_diff, 1 as cartodb_id FROM hgrid, (<%= subquery %>) i where ST_Intersects(i.the_geom_webmercator, hgrid.cell) GROUP BY hgrid.cell, i.id_partido